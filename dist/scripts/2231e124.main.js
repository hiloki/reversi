!function(){"use strict";_.mixin({selectAtRandom:function(a){return _.isArray(a)?a.length?a[_.random(a.length-1)]:null:null}})}();var App={};App.mediator=_.extend({},Backbone.Events),App.alert=function(a){alert(a)},function(){"use strict";App.CPUStrategy={};var a=Backbone.Model.extend({cells:null,color:null,collection:null,initialize:function(a){this.cells=a.cells,this.color=a.color,this.collection=a.collection},select:function(a){if(!this.cells.length)return null;var b=this.cells;if(_.isArray(a))for(var c=0,d=a.length;d>c;c++){var e=a[c];e=_.bind(e,_.extend({},this,{cells:b}))();var f=e.cells;f.length&&(b=f)}return _.selectAtRandom(b)},not:function(a){_.isFunction(a)||_.isString(a)&&(a=this[a]);var b=_.extend({},this,{filter:function(a){return this.cells=_.reject(this.cells,a),this}});return _.bind(a,b)},filter:function(a){return this.cells=_.filter(this.cells,a),this},edge:function(){return this.filter(function(a){return a.isEdge()})},corner:function(){return this.filter(function(a){return a.isCorner()})},aroundCorner:function(){return this.filter(function(a){return a.isAroundCorner()})},createReversiMap:function(){var a=this.color,b={};return _.each(this.cells,function(c){var d=c.countReverse(a);b[d]||(b[d]=[]),b[d].push(c)}),b},mostReversable:function(){var a=this.createReversiMap(),b=parseInt(_.max(_.keys(a))),c=this.color;return this.filter(function(a){return a.countReverse(c)===b})},leastReversable:function(){var a=this.createReversiMap(),b=parseInt(_.min(_.keys(a))),c=this.color;return this.filter(function(a){return a.countReverse(c)===b})},starPosition:function(){return this.filter(function(a){return a.isStarPosition()})}});App.CPUStrategy.StrategyModel=Backbone.Model.extend({initialize:function(a){this.collection=a.collection},selectCell:function(){throw"Not implements selectCell"},putReversi:function(a){var b=this.collection.getCandidates(a);if(!b.length)return!1;var c=this.selectCell(b,a);return c?c.putReversi(a):!1},strategy:function(b,c){return new a({collection:this.collection,cells:b,color:c})}})}(),function(){"use strict";App.CPUStrategy.EasyStrategyModel=App.CPUStrategy.StrategyModel.extend({selectCell:function(a,b){var c=this.collection,d=c.edge,e=this.strategy(a,b);return c.countReversies()<d*d/4?e.mostReversable():e.leastReversable(),e.select([e.starPosition,e.aroundCorner,e.not(e.edge)])}})}(),function(){"use strict";App.CPUStrategy.HardStrategyModel=App.CPUStrategy.StrategyModel.extend({putReversi:function(){}})}(),function(){"use strict";App.CPUStrategy.NormalStrategyModel=App.CPUStrategy.StrategyModel.extend({selectCell:function(a,b){var c,d=this.collection,e=d.edge,f=this.strategy(a,b);return c=d.countReversies()<e*e*.6?f.leastReversable:f.mostReversable,f.select([f.corner,f.not(f.starPosition),f.not(f.aroundCorner),f.edge,c])}})}(),function(){"use strict";var a=App.CPUStrategy,b={easy:"easy",normal:"normal",hard:"hard"};App.CPUModel=Backbone.Model.extend({strategies:null,strategy:null,defaults:function(){return{level:b.easy}},validate:function(a){return _.indexOf(b,a.level)?"Invalid level: "+a.level:void 0},initialize:function(c){var d=c.collection,e=b;this.strategies=[],this.strategies[e.easy]=new a.EasyStrategyModel({collection:d}),this.strategies[e.normal]=new a.NormalStrategyModel({collection:d}),this.strategies[e.hard]=new a.HardStrategyModel({collection:d}),this.setLevel(c.level)},putReversi:function(a){return this.getStrategy().putReversi(a)},setLevel:function(a){this.set("level",a,{validate:!0}),this.strategy=this.strategies[a]},getStrategy:function(){return this.strategy||this.setLevel(this.get("level")),this.strategy}},{levels:b})}(),function(){"use strict";var a="black",b="white",c="none";App.ReversiModel=Backbone.Model.extend({cell:null,initialize:function(a){this.set("color",c,{slient:!0}),this.cell=a.cell},getColor:function(){return this.get("color")},setColor:function(a){return a===this.get("color")?!0:App.ReversiModel.validColor(a)?(this.set("color",a),!0):!1},hasColor:function(a){return a?this.get("color")===a:this.get("color")!==c},toggle:function(){return this.getColor()===a?this.setColor(b):this.getColor()===b?this.setColor(a):void 0},hasDifferentColor:function(c){return c===b?this.get("color")===a:c===a?this.get("color")===b:!1}},{validColor:function(a){return _.indexOf(_.values(this.colorCode),a)>-1},colorCode:{black:a,white:b,none:c}})}(),function(){"use strict";App.CellModel=Backbone.Model.extend({row:0,col:0,reversi:null,initialize:function(a){a=_.extend({row:0,col:0},a),this.row=a.row,this.col=a.col,this.reversi=new App.ReversiModel({cell:this})},putReversi:function(a,b){return b=_.extend({validation:!0,reverse:!0},b),console.log("Set reversi (row, col) = ("+this.row+","+this.col+") color:"+a),b.validation&&this.hasReversi()?!1:b.reverse&&!this.reverse(a)&&b.validation?!1:this.reversi.setColor(a)},putBlackReversi:function(){return this.reversi.setColor(App.ReversiModel.colorCode.black)},putWhiteReversi:function(){return this.reversi.setColor(App.ReversiModel.colorCode.white)},hasReversi:function(a){return this.reversi.hasColor(a)},getPoint:function(a){return a?{row:this.row,col:this.col}:[this.row,this.col]},getColor:function(){return this.reversi.getColor()},reverse:function(a){for(var b=[{row:-1,col:-1},{row:-1,col:0},{row:-1,col:1},{row:0,col:-1},{row:0,col:1},{row:1,col:-1},{row:1,col:0},{row:1,col:1}],c=0,d=0,e=b.length;e>d;d++){var f=b[d];this.countReverseToVector(f,a)>0&&(c+=this.toggleRecursively(f,a))}return c>0},countReverse:function(a){for(var b=[{row:-1,col:-1},{row:-1,col:0},{row:-1,col:1},{row:0,col:-1},{row:0,col:1},{row:1,col:-1},{row:1,col:0},{row:1,col:1}],c=0,d=0,e=b.length;e>d;d++){var f=b[d];c+=this.countReverseToVector(f,a)}return c},canPutReversi:function(a){return!this.hasReversi()&&this.countReverse(a)>0},countReverseToVector:function(a,b){var c=!0,d=_.bind(function(a,b,e){var f=a.row+b.row,g=a.col+b.col;return a=this.collection.search(f,g),a?a.hasReversi()?a.reversi.hasDifferentColor(e)?1+d(a,b,e):0:(c=!1,0):(c=!1,0)},this),e=d(this,a,b);return c?e:!1},toggleRecursively:function(a,b){var c=_.bind(function(a,b,d){var e=a.row+b.row,f=a.col+b.col;return a=this.collection.search(e,f),a&&a.hasReversi()&&a.reversi.hasDifferentColor(d)?(a.reversi.toggle(),1+c(a,b,d)):0},this);return c(this,a,b)},isEquals:function(a){return a.row===this.row&&a.col===this.col},isEdge:function(){var a=this.collection.edge-1;return 0===this.row||this.row===a||0===this.col||this.col===a},isCorner:function(){var a=this.collection.edge-1;return 0===this.row&&0===this.col||0===this.row&&this.col===a||this.row===a&&0===this.col||this.row===a&&this.col===a},isAroundCorner:function(){var a=this.collection.edge-1;return this.isStarPosition()||0===this.row&&1===this.col||1===this.row&&0===this.col||this.row===a-1&&0===this.col||this.row===a&&1===this.col||0===this.row&&this.col===a-1||1===this.row&&this.col===a||this.row===a-1&&this.col===a||this.row===a&&this.col===a-1},isStarPosition:function(){var a=this.collection.edge-1;return 1===this.row&&1===this.col||1===this.row&&this.col===a-1||this.row===a-1&&1===this.col||this.row===a-1&&this.col===a-1},toString:function(){return"(row, col) = ("+this.row+","+this.col+")"}})}(),function(){"use strict";var a=App.ReversiModel.colorCode;App.CellCollection=Backbone.Collection.extend({model:App.CellModel,edge:0,initialize:function(a,b){var c=this.edge=b.edge;a=[];for(var d=0;c>d;d++)for(var e=0;c>e;e++)a.push(new App.CellModel({row:d,col:e}));this.reset(a,_.extend({silent:!0},b))},setInitialReversi:function(){var b=this.edge;this.addReversi(b/2-1,b/2-1,a.black),this.addReversi(b/2-1,b/2,a.white),this.addReversi(b/2,b/2-1,a.white),this.addReversi(b/2,b/2,a.black)},addReversi:function(a,b,c){var d=this.search(a,b);return d?d.putReversi(c,{validation:!1,reverse:!1}):!1},putReversi:function(a,b,c){var d=this.search(a,b);return d?d.putReversi(c):!1},isFullReversi:function(){return this.countReversies()===this.edge*this.edge},isOnlyColor:function(){return this.isOnly(a.black)||this.isOnly(a.white)},isOnly:function(a){return this.countReversies(a)===this.countReversies()},search:function(a,b){var c=this.filter(function(c){return c.row===a&&c.col===b});return c.length?c[0]:null},getCellsPuttingReversi:function(a){return this.filter(function(b){return b.hasReversi(a)})},getReversies:function(a){var b=this.getCellsPuttingReversi(),c=_.map(b,function(a){return a.reversi});return a?_.filter(c,function(b){return b.getColor()===a}):c},countReversies:function(a){return this.getReversies(a).length},getCandidates:function(a){return this.filter(function(b){return b.canPutReversi(a)})},countCandidates:function(a){return this.getCandidates(a).length}})}(),function(){"use strict";App.ReversiView=Backbone.View.extend({tagName:"div",className:"reversi",model:null,render:function(){if(this.$el.removeClass(),this.model.hasColor()){var a=this.model.getColor();this.$el.addClass(a)}return this.$el.addClass(this.className),this}})}(),function(){"use strict";var a=App.ReversiModel.colorCode,b=a.black,c=a.white,d=!1;App.CellView=Backbone.View.extend({tagName:"td",className:"cell",isGameEnd:!1,model:null,cpu:null,reversiView:null,events:{click:"onClick"},initialize:function(a){a=_.extend({cpu:null},a),this.reversiView=new App.ReversiView({model:this.model.reversi}),this.cpu=a.cpu,this.listenTo(App.mediator,"cell:render",this.render)},onClick:function(a){return a.stopPropagation(),d||(d=!0,this.isGameEnd)?void 0:this.putReversiByPlayer()?(setTimeout(_.bind(function(){this.putReversiByCPU(),d=!1},this),1500),void 0):(d=!1,void 0)},putReversiByPlayer:function(){if(this.isGameEnd)return!1;var a=this.model.putReversi(b);return App.mediator.trigger("cell:render"),this.checkGameEnd()?!1:a},putReversiByCPU:function(){if(!this.isGameEnd){var a=this.cpu.putReversi(c);if(App.mediator.trigger("cell:render"),!this.checkGameEnd())return a?(0===this.model.collection.countCandidates(b)&&(this.cannotPutPlayerReversi(),this.putReversiByCPU()),void 0):(this.cannotPutCPUReversi(),void 0)}},checkGameEnd:function(){var a=this.model.collection;if(this.isGameEnd)return!0;if(a.isFullReversi())return this.finishGame("ゲームが終了しました。"),!0;if(a.isOnlyColor())return this.finishGame("オセロが一色のみになったのでゲームを終了します。"),!0;var d=a.countCandidates(b)+a.countCandidates(c);return d?!1:(this.finishGame("両方のオセロが置けなくなったのでゲームを終了します。"),!0)},finishGame:function(a){a||(a=""),this.isGameEnd=!0;var d=this.model.collection,e=d.countReversies(b),f=d.countReversies(c),g=e>f?"あなたの勝ちです。":f>e?"CPUの勝ちです。":"引き分けです。",h="あなた: "+e+"\nCPU:    "+f+"\n"+g;App.alert(a+"\n"+h)},cannotPutPlayerReversi:function(){this.isGameEnd||App.alert("あなたの番ですがオセロが置けません。CPUの番です。")},cannotPutCPUReversi:function(){this.isGameEnd||App.alert("CPUのオセロが置けません。あなたの番です。")},render:function(){return this.$el.empty(),this.$el.append(this.reversiView.render().el),this.model.canPutReversi(b)&&this.$el.append('<div class="candidate"></div>'),this}})}(),function(){"use strict";App.BoardView=Backbone.View.extend({tagName:"table",className:"board",collection:null,cpu:null,cellViews:null,initialize:function(a){this.cpu=a.cpu,this.collection=a.collection,this.listenTo(App.mediator,"board:render",this.renderBoard)},render:function(){return App.mediator.trigger("board:render"),App.mediator.trigger("cell:render"),this},renderBoard:function(){this.$el.empty();for(var a=this.collection.edge,b=[],c=0;a>c;c++){for(var d=$("<tr>"),e=[],f=0;a>f;f++){var g=this.getCellView(c,f);e.push(g.render().$el)}b.push(d.append(e))}this.$el.append(b)},getCellView:function(a,b){var c=this.getCellViews();return c[a][b]},getCellViews:function(){if(this.cellViews)return this.cellViews;for(var a=[],b=this.collection.edge,c=0;b>c;c++){a[c]=[];for(var d=0;b>d;d++)a[c][d]=new App.CellView({model:this.collection.search(d,c),cpu:this.cpu})}return this.cellViews=a,a}})}(),function(){"use strict";App.SettingView=Backbone.View.extend({el:"#settings",cpu:null,initialize:function(a){this.cpu=a.cpu,_.bindAll(this,"changeLevel")},events:{"click input[name=level]":"changeLevel"},changeLevel:function(a){var b=this.$(a.target).val();this.cpu.setLevel(b)}})}(),function(){"use strict";App.AppView=Backbone.View.extend({el:"#main",boardView:null,settingView:null,cpu:null,collection:null,edge:8,initialize:function(){this.collection=new App.CellCollection(!1,{edge:this.edge}),this.collection.setInitialReversi(),this.cpu=new App.CPUModel({collection:this.collection}),this.boardView=new App.BoardView({collection:this.collection,cpu:this.cpu}),this.settingView=new App.SettingView({collection:this.collection,cpu:this.cpu})},render:function(){this.$("#board").empty().append(this.boardView.render().$el)}})}(),function(){"use strict";App.exports={};var a=new App.AppView;a.render(),App.exports.view=a}();