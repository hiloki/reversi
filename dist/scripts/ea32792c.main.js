var App={};!function(){"use strict";App.CPUStrategy={},App.CPUStrategy.StrategyModel=Backbone.Model.extend({initialize:function(a){this.collection=a.collection},putReversi:function(){throw"Not implements _putReversi"}})}(),function(){"use strict";App.CPUStrategy.EasyStrategyModel=App.CPUStrategy.StrategyModel.extend({putReversi:function(a){var b=this.collection.getPutableReversiCells(a);if(!b.length)return!1;var c={};_.each(b,function(b){var d=b.countReverse(a);c[d]||(c[d]=[]),c[d].push(b)});var d=_.min(_.keys(c)),e=c[d],f=e[_.random(0,e.length-1)];return f.putReversi(a)?!0:(console.log("Could not put cell (row, col) = ("+f.row+", "+f.col+")"),!1)}})}(),function(){"use strict";App.CPUStrategy.HardStrategyModel=App.CPUStrategy.StrategyModel.extend({putReversi:function(){}})}(),function(){"use strict";App.CPUStrategy.NormalStrategyModel=App.CPUStrategy.StrategyModel.extend({putReversi:function(){}})}(),function(){"use strict";var a=App.CPUStrategy,b={easy:1,normal:2,hard:3};App.CPUModel=Backbone.Model.extend({defaults:function(){return{level:b.easy}},validate:function(a){return _.indexOf(b,a.level)?"Invalid level: "+a.level:void 0},strategies:[],strategy:null,initialize:function(c){var d={},e=c.collection,f=b;d[f.easy]=new a.EasyStrategyModel({collection:e}),d[f.normal]=new a.NormalStrategyModel({collection:e}),d[f.hard]=new a.HardStrategyModel({collection:e}),this.strategies=d,this.setLevel(c.level)},putReversi:function(a){return this.getStrategy().putReversi(a)},setLevel:function(a){this.set("level",a,{validate:!0}),this.strategy=this.strategies[a]},getStrategy:function(){return this.strategy||this.setLevel(this.get("level")),this.strategy}},{levels:b})}(),function(){"use strict";var a="black",b="white",c="none";App.ReversiModel=Backbone.Model.extend({cell:null,initialize:function(a){this.set("color",c,{slient:!0}),this.cell=a},getColor:function(){return this.get("color")},setColor:function(a){return a===this.get("color")?!0:App.ReversiModel.validColor(a)?(this.set("color",a),!0):!1},hasColor:function(a){return a?this.get("color")===a:this.get("color")!==c},toggle:function(){return this.getColor()===a?this.setColor(b):this.getColor()===b?this.setColor(a):void 0},hasDifferentColor:function(c){return c===b?this.get("color")===a:c===a?this.get("color")===b:!1}},{colorCode:{black:a,white:b,none:c},validColor:function(a){return _.indexOf(_.values(this.colorCode),a)>-1}})}(),function(){"use strict";App.CellModel=Backbone.Model.extend({row:0,col:0,reversi:null,initialize:function(a){a=_.extend({row:0,col:0},a),this.row=a.row,this.col=a.col,this.reversi=new App.ReversiModel(this)},putReversi:function(a,b){return b=_.extend({validation:!0,reverse:!0},b),console.log("Set reversi (row, col) = ("+this.row+","+this.col+") color:"+a),b.validation&&this.hasReversi()?!1:b.reverse&&!this.reverse(a)&&b.validation?!1:this.reversi.setColor(a)},putBlackReversi:function(){return this.reversi.setColor(App.ReversiModel.colorCode.black)},putWhiteReversi:function(){return this.reversi.setColor(App.ReversiModel.colorCode.white)},hasReversi:function(){return this.reversi.hasColor()},getPoint:function(a){return a?{row:this.row,col:this.col}:[this.row,this.col]},getColor:function(){return this.reversi.getColor()},reverse:function(a){for(var b=[{row:-1,col:-1},{row:-1,col:0},{row:-1,col:1},{row:0,col:-1},{row:0,col:1},{row:1,col:-1},{row:1,col:0},{row:1,col:1}],c=0,d=0,e=b.length;e>d;d++){var f=b[d];this.countReverseToVector(f,a)>0&&(c+=this.toggleRecursively(f,a))}return c>0},countReverse:function(a){for(var b=[{row:-1,col:-1},{row:-1,col:0},{row:-1,col:1},{row:0,col:-1},{row:0,col:1},{row:1,col:-1},{row:1,col:0},{row:1,col:1}],c=0,d=0,e=b.length;e>d;d++){var f=b[d];c+=this.countReverseToVector(f,a)}return c},canPutReversi:function(a){return!this.hasReversi()&&this.countReverse(a)>0},countReverseToVector:function(a,b){var c=!0,d=_.bind(function(a,b,e){var f=a.row+b.row,g=a.col+b.col,a=this.collection.search(f,g);return a?a.hasReversi()?a.reversi.hasDifferentColor(e)?1+d(a,b,e):0:(c=!1,0):(c=!1,0)},this),e=d(this,a,b);return c?e:!1},toggleRecursively:function(a,b){var c=_.bind(function(a,b,d){var e=a.row+b.row,f=a.col+b.col,a=this.collection.search(e,f);return a&&a.hasReversi()&&a.reversi.hasDifferentColor(d)?(a.reversi.toggle(),1+c(a,b,d)):0},this);return c(this,a,b)},toString:function(){return"(row, col) = ("+this.row+","+this.col+")"}})}(),function(){"use strict";var a=App.ReversiModel.colorCode;App.CellCollection=Backbone.Collection.extend({model:App.CellModel,edge:0,initialize:function(a,b){var c=this.edge=b.edge;a=[];for(var d=0;c>d;d++)for(var e=0;c>e;e++)a.push(new App.CellModel({row:d,col:e}));this.reset(a,_.extend({silent:!0},b)),this.setInitialReversi()},setInitialReversi:function(){var b=this.edge;this.addReversi(b/2-1,b/2-1,a.black),this.addReversi(b/2-1,b/2,a.white),this.addReversi(b/2,b/2-1,a.white),this.addReversi(b/2,b/2,a.black)},addReversi:function(a,b,c){var d=this.search(a,b);return d?d.putReversi(c,{validation:!1,reverse:!1}):!1},isFullReversi:function(){return this.countReversies()===this.edge*this.edge},isOnlyColor:function(){return this.isOnly(a.black)||this.isOnly(a.white)},isOnly:function(a){return this.countReversies(a)===this.countReversies()},putReversi:function(a,b){var c=this.search(a,b);return c?c.putReversi(color):!1},search:function(a,b){var c=this.filter(function(c){return c.row===a&&c.col===b});return c.length?c[0]:null},getCellsWithReversi:function(){return this.filter(function(a){return a.hasReversi()})},getReversies:function(a){var b=this.getCellsWithReversi(),c=_.map(b,function(a){return a.reversi});return a?_.filter(c,function(b){return b.getColor()===a}):c},countReversies:function(a){return this.getReversies(a).length},getPutableReversiCells:function(a){return this.filter(function(b){return b.canPutReversi(a)})},countPutableCells:function(a){return this.getPutableReversiCells(a).length}})}(),function(){"use strict";App.ReversiView=Backbone.View.extend({tagName:"div",className:"reversi",model:null,initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){if(this.$el.removeClass(),this.model.hasColor()){var a=this.model.getColor();this.$el.addClass(a)}return this.$el.addClass(this.className),this}})}(),function(){"use strict";var a=App.ReversiModel.colorCode,b=a.black,c=a.white;App.CellView=Backbone.View.extend({tagName:"td",className:"cell",isGameEnd:!1,model:null,cpu:null,events:{click:"onClick"},initialize:function(a){a=_.extend({cpu:null},a),this.cpu=a.cpu},onClick:function(a){a.stopPropagation(),this.checkGameEnd()||this.putReversi()},putReversi:function(){this.model.putReversi(b)&&(this.checkGameEnd()||this.putReversiByCPU())},putReversiByCPU:function(){return this.checkGameEnd()?!1:this.cpu.putReversi(c)?(this.checkGameEnd()||0===this.model.collection.countPutableCells(b)&&(this.cannotPutPlayerReversi(),this.putReversiByCPU()),void 0):(this.cannotPutCPUReversi(),void 0)},checkGameEnd:function(){var a=this.model.collection;return this.isGameEnd?!0:a.isFullReversi()||a.isOnlyColor()?(this.finishGame(),this.isGameEnd=!0,!0):!1},finishGame:function(){var a=this.model.collection,d=a.countReversies(b),e=a.countReversies(c),f=d>e?"あなたの勝ちです。":e>d?"CPUの勝ちです。":"引き分けです。",g="ゲームが終了しました。\nあなた: "+d+"\nCPU:    "+e+"\n"+f;alert(g)},cannotContinueGame:function(){var a=function(a){var b="オセロが一色のみになったのでゲームを終了します。\n"+a;return alert(b),!0};return collection.isOnly(c)?(a("あなたの勝ちです。"),!0):collection.isOnly(b)?(a("あなたの負けです。"),!0):!1},cannotPutPlayerReversi:function(){this.isGameEnd||alert("あなたの番ですがオセロが置けません。CPUの番です。")},cannotPutCPUReversi:function(){this.isGameEnd||alert("CPUのオセロが置けません。あなたの番です。")},render:function(){var a=new App.ReversiView({model:this.model.reversi});return this.$el.html(a.render().el),this.$el.data("row",this.model.row),this.$el.data("col",this.model.col),this}})}(),function(){"use strict";App.BoardView=Backbone.View.extend({tagName:"table",className:"board",collection:null,edge:0,cpu:null,initialize:function(a){var b=this.edge=a.edge;this.collection=new App.CellCollection(!1,{edge:b}),this.cpu=new App.CPUModel({collection:this.collection})},render:function(){for(var a=this.edge,b=[],c=0;a>c;c++){for(var d=$("<tr>"),e=[],f=0;a>f;f++){var g=new App.CellView({model:this.collection.search(f,c),cpu:this.cpu});e.push(g.render().$el)}b.push(d.append(e))}return this.$el.append(b),this}})}(),function(){"use strict";App.SettingView=Backbone.View.extend({el:"#settings",cpu:null,initialize:function(a){this.cpu=new App.CPUModel({collection:a.collection}),_.bindAll(this,"changeLevel")},events:{"click #setting input[name=level]":"changeLevel"},changeLevel:function(a){var b=this.$(a.target).val();this.cpu.setLevel(b)}})}(),function(){"use strict";App.AppView=Backbone.View.extend({el:"#main",render:function(){this.boardView=new App.BoardView({edge:8}),this.$("#board").append(this.boardView.render().$el),this.settingView=new App.SettingView({collection:this.boardView.collection})}})}(),function(){"use strict";App.exports={};var a=new App.AppView;a.render(),App.exports.view=a}();